<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload Validation</title>
    <style>
        .spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .button-disabled {
            pointer-events: none;
            opacity: 0.6;
        }

        .allowed-files {
            font-size: 0.8em;
            color: #ff497c;
        }
    </style>
</head>
<body>
    <form id="formphotos" method="post" enctype="multipart/form-data" class="elementor-form">
        <div class="elementor-form-fields-wrapper elementor-labels-above">
            <div class="elementor-field-type-file elementor-field-group elementor-column elementor-field-group-companylogo elementor-col-100">
                <label for="companylogo" class="elementor-field-label">Company Logo <span class="allowed-files">(allowed files: jpg, png, jpeg)</span></label>
                <input type="file" id="companylogo" name="companylogo" class="elementor-field elementor-size-sm elementor-field-textual" accept="image/jpeg, image/png, image/gif">
                <img id="preview-companylogo" class="img-thumbnail" style="max-width: 100px; display: none;">
            </div>
            <div class="elementor-field-type-file elementor-field-group elementor-column elementor-field-group-profilephoto elementor-col-100">
                <label for="profilephoto" class="elementor-field-label">Profile Photo</label>
                <input type="file" id="profilephoto" name="profilephoto" class="elementor-field elementor-size-sm elementor-field-textual" accept="image/jpeg, image/png, image/gif">
                <img id="preview-profilephoto" class="img-thumbnail" style="max-width: 100px; display: none;">
            </div>
            <div class="elementor-field-group elementor-column elementor-field-type-submit elementor-col-100 e-form__buttons">
                <button class="elementor-button elementor-size-sm w-100" type="submit" id="submit-button">
                    <span class="elementor-button-content-wrapper">
                        <span class="elementor-button-text">Send</span>
                        <div class="spinner" id="spinner"></div>
                    </span>
                </button>
            </div>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('#formphotos');
            const submitButton = document.querySelector('#submit-button');
            const spinner = document.querySelector('#spinner');
            const companyLogoInput = document.querySelector('#companylogo');
            const companyLogoPreview = document.querySelector('#preview-companylogo');
            const profilePhotoInput = document.querySelector('#profilephoto');
            const profilePhotoPreview = document.querySelector('#preview-profilephoto');

            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
            const maxSize = 1048576; // 1 MB en bytes

            const validateFile = (file) => file && allowedTypes.includes(file.type) && file.size <= maxSize;

            const checkValidation = () => {
                const isCompanyLogoValid = validateFile(companyLogoInput.files[0]);
                const isProfilePhotoValid = validateFile(profilePhotoInput.files[0]);
                const isValid = isCompanyLogoValid || isProfilePhotoValid;

                submitButton.disabled = !isValid;
                submitButton.classList.toggle('button-disabled', !isValid);
            };

            const previewImage = (input, preview) => {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            };

            companyLogoInput.addEventListener('change', () => {
                previewImage(companyLogoInput, companyLogoPreview);
                checkValidation();
            });

            profilePhotoInput.addEventListener('change', () => {
                previewImage(profilePhotoInput, profilePhotoPreview);
                checkValidation();
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const companyLogo = companyLogoInput.files[0];
                const profilePhoto = profilePhotoInput.files[0];

                if (!validateFile(companyLogo) && !validateFile(profilePhoto)) {
                    return;
                }

                spinner.style.display = 'inline-block';
                submitButton.classList.add('button-disabled');
                [...form.elements].forEach(el => el.disabled = true);

                try {
                    const formData = new FormData(form);
                    formData.append('action', 'save_acf_images_update_photos');

                    const response = await fetch('/wp-admin/admin-ajax.php', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('Images saved successfully.');
                        window.location.reload();
                    } else {
                        alert('Error saving images: ' + data.data);
                    }
                } catch (error) {
                    console.error('Request error:', error);
                    alert('There was an error processing the form.');
                } finally {
                    spinner.style.display = 'none';
                    submitButton.classList.remove('button-disabled');
                    [...form.elements].forEach(el => el.disabled = false);
                }
            });
        });
    </script>
</body>
</html>
